#pragma bank=10

#include <stdio.h>
#include <stdlib.h>
#include "game.h"
#include "Pong.h"
#include "UI.h"
#include "BankData.h"
#include "FadeManager.h"
#include "SpriteHelpers.h"
#include "Macros.h"

UINT8 pong_bank = 10;

////////////////////////////////////////////////////////////////////////////////
// Private vars
////////////////////////////////////////////////////////////////////////////////
#pragma region private vars

const unsigned char pong_bg[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

const unsigned char pong_tiles[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

const unsigned char pong_score[] = {
0x00,0x00,0x3C,0x3C,0x62,0x62,0x52,0x52,0x4A,0x4A,0x46,0x46,0x3C,0x3C,0x00,0x00,0x00,0x00,0x18,0x18,0x28,0x28,0x08,0x08,0x08,0x08,0x08,0x08,0x3C,0x3C,0x00,0x00,0x00,0x00,0x3C,0x3C,0x42,0x42,0x02,0x02,0x3C,0x3C,0x40,0x40,0x7E,0x7E,0x00,0x00,0x00,0x00,0x7C,0x7C,0x02,0x02,0x0C,0x0C,0x02,0x02,0x02,0x02,0x7E,0x7E,0x00,0x00,0x00,0x00,0x40,0x40,0x40,0x40,0x48,0x48,0x7E,0x7E,0x08,0x08,0x08,0x08,0x00,0x00,0x00,0x00,0x7E,0x7E,0x40,0x40,0x7C,0x7C,0x02,0x02,0x02,0x02,0x7C,0x7C,0x00,0x00,0x00,0x00,0x3C,0x3C,0x40,0x40,0x7C,0x7C,0x42,0x42,0x42,0x42,0x3C,0x3C,0x00,0x00,0x00,0x00,0x7E,0x7E,0x02,0x02,0x04,0x04,0x08,0x08,0x10,0x10,0x20,0x20,0x00,0x00,0x00,0x00,0x3C,0x3C,0x42,0x42,0x3C,0x3C,0x42,0x42,0x42,0x42,0x3C,0x3C,0x00,0x00,0x00,0x00,0x3C,0x3C,0x42,0x42,0x42,0x42,0x3E,0x3E,0x02,0x02,0x3C,0x3C,0x00,0x00
};

const unsigned char pong_score_ptr[] = {0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10};

const unsigned char pong_paddle[] = {
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
};

const unsigned char pong_ball[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
};

static void _pong_next();
static void PongRender();
static void PongIncScoreLeft();
static void PongIncScoreRight();
static void PongHandleInput();

static UBYTE pong_slide = 0;
static UBYTE pong_paddle_left = 0;
static UBYTE pong_paddle_right = 0;
static UBYTE pong_score_left = 0;
static UBYTE pong_score_right = 0;
static UBYTE pong_ball_x = 0;
static UBYTE pong_ball_y = 0;
static UBYTE pong_ball_left = FALSE;
static UBYTE pong_ball_up = FALSE;
static UBYTE pong_ai_timer = 0;
static UBYTE pong_bounces = 0;
static UBYTE pong_speed = 1;

static UBYTE pong_timer = 0;
static UBYTE pong_state = 0;
static UBYTE pong_exit;
static UBYTE pong_playing = FALSE;

#pragma endregion

////////////////////////////////////////////////////////////////////////////////
// Private functions
////////////////////////////////////////////////////////////////////////////////
#pragma region private functions

#pragma endregion

////////////////////////////////////////////////////////////////////////////////
// Initialise
////////////////////////////////////////////////////////////////////////////////
#pragma region initialise

void PongInit_b()
{
  DISPLAY_OFF;

  SpritesReset();

  WX_REG = MAXWNDPOSX;
  WY_REG = MAXWNDPOSY;

  pong_slide = 0;
  pong_paddle_left = 72;
  pong_paddle_right = 72;
  pong_score_left = 0;
  pong_score_right = 0;
  pong_ball_x = 0;
  pong_ball_y = 0;
  pong_ball_left = FALSE;
  pong_ball_up = FALSE;  
  pong_bounces = 0;

  pong_timer = 20;

  pong_state = 0;

  /* Initialize the background */
  set_bkg_data(0x00, 0x07, pong_tiles);
  set_bkg_data(0x07, 0x0A, pong_score);

  // set_bkg_data(0xC0, 0x40, global_tiles_data);

  set_bkg_tiles(0, 0, 20, 18, pong_bg);

  // Score
  set_bkg_tiles(4, 2, 1, 1, pong_score_ptr+0);
  set_bkg_tiles(15, 2, 1, 1, pong_score_ptr+0);


  set_sprite_data(0x00, 0x02, pong_paddle);
  set_sprite_data(0x02, 0x02, pong_ball);

  set_sprite_tile(0, 2);
  set_sprite_tile(1, 0);
  set_sprite_tile(2, 0);
  set_sprite_tile(3, 0);
  set_sprite_tile(4, 0);

  move_sprite(0, 84, 40);
  move_sprite(1, PONG_PADDLE_LEFT_X, 56);
  move_sprite(2, PONG_PADDLE_LEFT_X, 72);
  move_sprite(3, PONG_PADDLE_RIGHT_X, 56);
  move_sprite(4, PONG_PADDLE_RIGHT_X, 72);

  pong_playing = FALSE;
  pong_exit = FALSE;

  FadeIn();

  DISPLAY_ON;
}

#pragma endregion

////////////////////////////////////////////////////////////////////////////////
// Update
////////////////////////////////////////////////////////////////////////////////
#pragma region update

void PongUpdate_b()
{
  PongHandleInput();

  if(pong_playing) {
    if(pong_ball_left) {
      pong_ball_x -= pong_speed;
    } else {
      pong_ball_x += pong_speed;
    }
    if(pong_ball_up) {
      pong_ball_y -= pong_speed;
    } else {
      pong_ball_y += pong_speed;
    }    

    // AI
    if(pong_ai_timer == 0) {
      pong_ai_timer = 120;
    }

    pong_ai_timer--;

    if(pong_ai_timer > 20 && pong_ball_x > 40) {
      if(pong_ball_y > pong_paddle_right) {
        pong_paddle_right += PONG_PADDLE_SPEED;
      } else if (pong_ball_y < pong_paddle_right) {
        pong_paddle_right -= PONG_PADDLE_SPEED;
      }
    }
    // pong_paddle_right = 103;

    // Right bounds
    if(pong_paddle_right < 16) {
      pong_paddle_right = 16;
    } else if (pong_paddle_right > 128) {
      pong_paddle_right = 128;
    }

    // Hit paddle left
    if(pong_ball_x < 32 && pong_ball_x > 28 && pong_ball_y > pong_paddle_left - 16 && pong_ball_y < pong_paddle_left + 24) {
      pong_ball_left = FALSE;
      pong_ball_up = pong_ball_y < pong_paddle_left;
      pong_bounces++;
    }

    // Hit paddle right
    if(pong_ball_x > 136 && pong_ball_x < 140 && pong_ball_y > pong_paddle_right - 16 && pong_ball_y < pong_paddle_right + 24) {
      pong_ball_left = TRUE;
      pong_ball_up = pong_ball_y < pong_paddle_right;
      pong_bounces++;
    }

    if(pong_bounces > 2 && pong_speed < 8) {
      pong_speed++;
      pong_bounces = 0;
    }

    // Score
    if(pong_ball_x > 160) {
      PongIncScoreLeft();
    } else if(pong_ball_x < 8) {
      PongIncScoreRight();      
    }

    if(pong_ball_y > 144) {
      pong_ball_up = TRUE;
    } else if(pong_ball_y < 8) {
      pong_ball_up = FALSE;
    }    
  }

  PongRender();
}

static void PongIncScoreLeft()
{
  pong_score_left++;
  pong_playing = FALSE;    

  if(pong_score_left > 3) {
    _pong_next();
  } else {
    set_bkg_tiles(4, 2, 1, 1, pong_score_ptr+pong_score_left);
  }
}

static void PongIncScoreRight()
{
  pong_score_right++;
  pong_playing = FALSE;    

  if(pong_score_right > 3) {
    _pong_next();
  } else {
    set_bkg_tiles(15, 2, 1, 1, pong_score_ptr+pong_score_right);
  }
}

static void _pong_next()
{
  if (pong_exit) {
    return;
  }
  pong_exit = TRUE;
  FadeSetSpeed(4);
  FadeOut();
  stage_next_type = MAP;
}

////////////////////////////////////////////////////////////////////////////////
// Input
////////////////////////////////////////////////////////////////////////////////
#pragma region input

static void PongHandleInput()
{
  if(!pong_playing && joy & J_A) {
    pong_playing = TRUE;
    pong_ball_x = 84;
    pong_ball_y = 72; 
    pong_bounces = 0;
    pong_speed = 1; 
  }

  if (joy & J_UP) {
    pong_paddle_left -= PONG_PADDLE_SPEED;
  } else if (joy & J_DOWN) {
    pong_paddle_left += PONG_PADDLE_SPEED;
  }

  if(pong_paddle_left < 16) {
    pong_paddle_left = 16;
  } else if (pong_paddle_left > 128) {
    pong_paddle_left = 128;
  }
}

#pragma endregion

////////////////////////////////////////////////////////////////////////////////
// Render
////////////////////////////////////////////////////////////////////////////////
#pragma region render

void PongRender()
{
  // Left Paddle
  move_sprite(1, PONG_PADDLE_LEFT_X, pong_paddle_left);
  move_sprite(2, PONG_PADDLE_LEFT_X, pong_paddle_left+16);

  // Right Paddle
  move_sprite(3, PONG_PADDLE_RIGHT_X, pong_paddle_right);
  move_sprite(4, PONG_PADDLE_RIGHT_X, pong_paddle_right+16);  

  // Ball
  if(pong_playing) {
    move_sprite(0, pong_ball_x, pong_ball_y);
  } else {
    move_sprite(0, 0, 0);
  }
}

#pragma endregion

////////////////////////////////////////////////////////////////////////////////
// Helpers
////////////////////////////////////////////////////////////////////////////////
#pragma region helpers

#pragma endregion
